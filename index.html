<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improv Suggestions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            text-align: center;
        }
        table {
            margin: 20px auto;
            width: 80%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            font-size: 18px;
        }
        th {
            width: 20%;
        }
        th:nth-child(2) {
            width: 70%;
        }
        th:nth-child(3) {
            width: 10%;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="suggestionButton" style="font-size: 20px; padding: 10px 20px;">Get Suggestion</button>
        <p id="suggestion" style="font-size: 24px; margin-top: 20px;"></p>
        <input type="text" id="dialogueInput" placeholder="Type your line of dialogue..." style="font-size: 18px; padding: 10px; width: 80%; margin-top: 20px;">
        <table id="suggestionsTable">
            <thead>
                <tr>
                    <th>Suggestion</th>
                    <th>Initiation</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="suggestions"></tbody>
        </table>
        <button id="evaluateButton" style="font-size: 20px; padding: 10px 20px; margin-top: 20px;">Evaluate Trends</button>
        <div id="evaluationResult" style="margin-top: 20px; font-size: 18px;"></div>
    </div>

    <script>
        let suggestions = [];
        let startTime;

        // Fetch the CSV file and parse it
        document.addEventListener('DOMContentLoaded', function() {
            fetch('https://raw.githubusercontent.com/TerrTerr/Initiation_Practice2/main/suggestions.csv')
                .then(response => response.text())
                .then(data => {
                    suggestions = data.split('\n').slice(1).map(line => line.trim()); // Parse CSV data
                })
                .catch(error => console.error('Error fetching suggestions:', error));
        });

        document.getElementById('suggestionButton').addEventListener('click', function() {
            if (suggestions.length > 0) {
                const randomIndex = Math.floor(Math.random() * suggestions.length);
                const suggestion = suggestions[randomIndex];
                document.getElementById('suggestion').innerText = suggestion;
                startTime = new Date();  // Start the timer
            }
        });

        document.getElementById('dialogueInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const suggestion = document.getElementById('suggestion').innerText;
                const dialogue = event.target.value;
                if (suggestion && dialogue) {
                    const endTime = new Date();
                    let timeTaken = Math.round((endTime - startTime) / 1000); // Calculate time taken in seconds and round to the nearest whole number
                    
                    let minutes = Math.floor(timeTaken / 60);
                    let seconds = timeTaken % 60;
                    let timeDisplay = seconds + ' sec';
                    if (minutes > 0) {
                        timeDisplay = minutes + ' min, ' + timeDisplay;
                    }

                    const tableBody = document.getElementById('suggestions');
                    const row = document.createElement('tr');
                    const suggestionCell = document.createElement('td');
                    const dialogueCell = document.createElement('td');
                    const timeCell = document.createElement('td');

                    suggestionCell.style.border = '1px solid #ccc';
                    suggestionCell.style.padding = '10px';
                    suggestionCell.style.fontSize = '18px';
                    suggestionCell.style.width = '20%';

                    dialogueCell.style.border = '1px solid #ccc';
                    dialogueCell.style.padding = '10px';
                    dialogueCell.style.fontSize = '18px';
                    dialogueCell.style.width = '70%';

                    timeCell.style.border = '1px solid #ccc';
                    timeCell.style.padding = '10px';
                    timeCell.style.fontSize = '18px';
                    timeCell.style.width = '10%';

                    suggestionCell.innerText = suggestion;
                    dialogueCell.innerText = dialogue;
                    timeCell.innerText = timeDisplay;

                    row.appendChild(suggestionCell);
                    row.appendChild(dialogueCell);
                    row.appendChild(timeCell);
                    tableBody.insertBefore(row, tableBody.firstChild); // Add the new row at the top

                    document.getElementById('suggestion').innerText = '';  // Clear the suggestion
                    event.target.value = '';
                }
            }
        });

        document.getElementById('evaluateButton').addEventListener('click', function() {
            const rows = document.querySelectorAll('#suggestions tr');
            let data = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 3) {
                    const suggestion = cells[0].innerText;
                    const initiation = cells[1].innerText;
                    data.push({ suggestion, initiation });
                }
            });

            // Ensure the model name is correct and prompt length is within limits
            const apiKey = 'sk-proj-Bn19bfS5o0gVqDKGcDaaT3BlbkFJMfT9vPdZtyWlzIk5MmMg';
            const model = 'gpt-4:ft-your-fine-tuned-model';
            const basePrompt = `Please assess the following initiation(s) (an initiation is the first lines of an improv comedy scene) based on this specific criteria. The suggestions the initiations are based on will also be provided. Criteria for evaluation include:
1. Positive attributes, praise adding information known as the 'base reality': including WHO the characters are (relationship), WHERE the scene is taking place, and WHAT is happening in the scene. Not as important but sometimes considered to be part of the base reality is an opinion or feeling held by either character. So starting with a strong feeling or opinion is considered good, but not as good as saying WHO, WHERE and/or WHAT.
2. Negative attributes: criticize initiations that are missing all essential elements of the base reality (who, where, what, opinion/feeling), or include overt conflicts, problems, accusations, excessive vagueness, focus on situations or problems rather than characters, feature significant coyness, questions, establishing dislike or stranger relationships between characters, first-day scenarios or characters being below average intelligence, detrimental inclusion of the suggestion, and initiating with excessively dramatic or overly exciting lines. Minor excitement or other feeling is acceptable. Initiations that are overly complex or tricky for the scene partner can also be noted as potentially problematic.
3. Initiating without conflict and with mundane, every-day lines is considered good.
Focus your feedback on three main points, mentioning that there are many potential notes but concentrating on these three. The feedback should not be numbered but instead delivered as a discussion. Avoid going through initiations one by one. Instead, broad notes that apply to multiple scenes will be provided, with examples as needed. The absence of one or two positive attributes (base reality elements) is not necessarily bad and should not be noted for improvement unless all elements are missing or largely missing multiple times. Feedback will be concise, limited to 100 words, and the tone of communication is friendly and casual.`;

            const fullPrompt = `${basePrompt}\n\n${data.map(item => `Suggestion: ${item.suggestion}\nInitiation: ${item.initiation}`).join('\n\n')}`;

            fetch('https://api.openai.com/v1/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    prompt: fullPrompt,
                    max_tokens: 500
                })
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('evaluationResult').innerText = result.choices && result.choices.length > 0 ? result.choices[0].text.trim() : "Evaluation completed.";
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>
